╔═══════════════════════════════════════════════════════════════════════════════╗
║                    TINDER AI PLATFORM - ER ДІАГРАМА                          ║
║                           База Даних PostgreSQL                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝


┌─────────────────────────────────────────────────────────────────────────────┐
│                              СУТНОСТІ (ENTITIES)                             │
└─────────────────────────────────────────────────────────────────────────────┘


╔══════════════════════════╗
║         USERS            ║
╠══════════════════════════╣
║ PK: id (UUID)            ║
╟──────────────────────────╢
║ • username (UK)          ║
║ • email (UK)             ║
║ • password_hash          ║
║ • full_name              ║
║ • role (ENUM)            ║
║ • is_active (BOOL)       ║
║ • created_at             ║
║ • updated_at             ║
║ • last_login_at          ║
╚══════════════════════════╝
           │
           │ 1:N
           ├────────────────────────────────────┐
           │                                    │
           │ 1:N                           1:1  │
           ▼                                    ▼
╔═══════════════════════════╗        ╔═══════════════════════════╗
║        CONTENT            ║        ║      USER_INSIGHTS        ║
╠═══════════════════════════╣        ╠═══════════════════════════╣
║ PK: id (UUID)             ║        ║ PK: user_id (UUID)        ║
║ FK: template_id           ║        ╟───────────────────────────╢
║ FK: user_id               ║        ║ • likes_json (JSONB)      ║
║ FK: parent_id (self)      ║        ║   [{keyword, count}, ...] ║
╟───────────────────────────╢        ║ • dislikes_json (JSONB)   ║
║ • url (UK)                ║        ║   [{keyword, count}, ...] ║
║ • media_type (ENUM)       ║        ║ • preferences_json        ║
║ • original_prompt         ║        ║ • total_swipes (INT)      ║
║ • enhanced_prompt         ║        ║ • total_likes (INT)       ║
║ • final_prompt            ║        ║ • total_dislikes (INT)    ║
║ • model                   ║        ║ • total_superlikes (INT)  ║
║ • meta_json (JSONB)       ║        ║ • gold_content_ids[]      ║
║ • generation_params       ║        ║ • last_activity_at        ║
║ • total_ratings (INT)     ║        ║ • updated_at              ║
║ • likes_count (INT)       ║        ╚═══════════════════════════╝
║ • dislikes_count (INT)    ║                     ▲
║ • superlikes_count (INT)  ║                     │
║ • like_rate (FLOAT)       ║                     │ Оновлюється
║ • created_at              ║                     │ кожні 10 ratings
╚═══════════════════════════╝                     │
           │                                      │
           │ 1:N                                  │
           ▼                                      │
╔═══════════════════════════╗                    │
║         RATINGS           ║                    │
╠═══════════════════════════╣                    │
║ PK: id (UUID)             ║                    │
║ FK: content_id            ║                    │
║ FK: user_id               ║────────────────────┘
╟───────────────────────────╢
║ • direction (ENUM)        ║
║   - left (dislike)        ║
║   - right (like)          ║
║   - up (superlike)        ║
║   - down (skip)           ║
║ • comment (TEXT)          ║  ← ВАЖЛИВО для insights!
║ • latency_ms (INT)        ║
║ • user_weight (FLOAT)     ║
║ • meta_json (JSONB)       ║
║ • created_at              ║
╚═══════════════════════════╝


╔════════════════════════════╗
║    PROMPT_TEMPLATES        ║
╠════════════════════════════╣
║ PK: id (UUID)              ║
╟────────────────────────────╢
║ • name (UK)                ║
║ • description              ║
║ • category (VARCHAR)       ║
║ • base_prompt (TEXT)       ║
║ • system_instructions      ║
║ • model (VARCHAR)          ║
║ • model_params (JSONB)     ║
║ • version (INT)            ║
║ • active (BOOL)            ║
║ • insights_json (JSONB)    ║
║   {likes: [], dislikes:[]} ║
║ • total_uses (INT)         ║
║ • avg_like_rate (FLOAT)    ║
║ • created_at               ║
║ • updated_at               ║
╚════════════════════════════╝
           │
           │ 1:N
           │ використовує
           ▼
      [до CONTENT]


┌─────────────────────────────────────────────────────────────────────────────┐
│                           ЗВІ'ЯЗКИ (RELATIONSHIPS)                           │
└─────────────────────────────────────────────────────────────────────────────┘

1. USERS ←──┤1:N├── CONTENT
   └─ users.id = content.user_id
   └─ ON DELETE: SET NULL
   └─ Один користувач може створити багато контенту

2. USERS ←──┤1:N├── RATINGS
   └─ users.id = ratings.user_id
   └─ ON DELETE: CASCADE
   └─ Один користувач може залишити багато оцінок

3. USERS ←──┤1:1├── USER_INSIGHTS
   └─ users.id = user_insights.user_id
   └─ ON DELETE: CASCADE
   └─ Один користувач має один запис інсайтів

4. PROMPT_TEMPLATES ←──┤1:N├── CONTENT
   └─ prompt_templates.id = content.template_id
   └─ ON DELETE: SET NULL
   └─ Один шаблон використовується для багатьох контентів

5. CONTENT ←──┤1:N├── RATINGS
   └─ content.id = ratings.content_id
   └─ ON DELETE: CASCADE
   └─ Один контент отримує багато оцінок

6. CONTENT ←──┤1:N├── CONTENT (self-reference)
   └─ content.id = content.parent_id
   └─ ON DELETE: SET NULL
   └─ Батьківський контент може мати багато варіацій


┌─────────────────────────────────────────────────────────────────────────────┐
│                         ТРИГЕРИ (DATABASE TRIGGERS)                          │
└─────────────────────────────────────────────────────────────────────────────┘

1. ⚡ update_content_stats
   Коли:  AFTER INSERT ON ratings
   Дія:   Автоматично оновлює content.total_ratings, likes_count, 
          dislikes_count, superlikes_count, like_rate

2. ⚡ update_updated_at_column
   Коли:  BEFORE UPDATE ON prompt_templates, user_insights
   Дія:   Автоматично встановлює updated_at = NOW()


┌─────────────────────────────────────────────────────────────────────────────┐
│                      ІНДЕКСИ ДЛЯ ОПТИМІЗАЦІЇ (INDEXES)                      │
└─────────────────────────────────────────────────────────────────────────────┘

USERS:
  • idx_users_username (username)
  • idx_users_email (email)
  • idx_users_role (role)

PROMPT_TEMPLATES:
  • idx_prompt_templates_name (name)
  • idx_prompt_templates_active (active)
  • idx_prompt_templates_category (category)

CONTENT:
  • idx_content_created (created_at DESC)
  • idx_content_user (user_id)
  • idx_content_template (template_id)
  • idx_content_like_rate (like_rate DESC)
  • idx_content_url_unique (url) UNIQUE
  • idx_content_media_type (media_type)

RATINGS:
  • idx_ratings_content (content_id)
  • idx_ratings_user (user_id)
  • idx_ratings_direction (direction)
  • idx_ratings_user_content_unique (user_id, content_id) UNIQUE

USER_INSIGHTS:
  • PRIMARY KEY на user_id (автоматичний індекс)


┌─────────────────────────────────────────────────────────────────────────────┐
│                    ОБМЕЖЕННЯ ЦІЛІСНОСТІ (CONSTRAINTS)                        │
└─────────────────────────────────────────────────────────────────────────────┘

PRIMARY KEYS (PK):
  ✓ users.id
  ✓ prompt_templates.id
  ✓ content.id
  ✓ ratings.id
  ✓ user_insights.user_id

FOREIGN KEYS (FK):
  ✓ content.template_id → prompt_templates.id (SET NULL)
  ✓ content.user_id → users.id (SET NULL)
  ✓ content.parent_id → content.id (SET NULL)
  ✓ ratings.content_id → content.id (CASCADE)
  ✓ ratings.user_id → users.id (NOT NULL)
  ✓ user_insights.user_id → users.id (CASCADE)

UNIQUE CONSTRAINTS (UK):
  ✓ users.username
  ✓ users.email
  ✓ prompt_templates.name
  ✓ content.url
  ✓ ratings(user_id, content_id)

CHECK CONSTRAINTS:
  ✓ users.role IN ('user', 'admin')
  ✓ content.media_type IN ('image', 'video', 'audio', 'text')
  ✓ ratings.direction IN ('left', 'right', 'up', 'down')


┌─────────────────────────────────────────────────────────────────────────────┐
│                       DATA FLOW: INSIGHTS PROCESS                            │
└─────────────────────────────────────────────────────────────────────────────┘

                        ┌─────────────┐
                        │   RATINGS   │
                        │  (36 total) │
                        └──────┬──────┘
                               │
                               ▼
                ┌──────────────────────────────┐
                │  Filter: r.comment != null   │
                │  ⚠️ ТІЛЬКИ З КОМЕНТАРЯМИ!   │
                └──────────┬───────────────────┘
                           │
            ┌──────────────┴──────────────┐
            │                             │
            ▼                             ▼
    ┌───────────────┐           ┌────────────────┐
    │ Like Comments │           │ Dislike Comments│
    │   (7 items)   │           │    (4 items)    │
    └───────┬───────┘           └────────┬────────┘
            │                            │
            ▼                            ▼
    ┌───────────────┐           ┌────────────────┐
    │ OpenAI Analyze│           │ OpenAI Analyze │
    │   GPT-4o-mini │           │   GPT-4o-mini  │
    └───────┬───────┘           └────────┬────────┘
            │                            │
            └────────────┬───────────────┘
                         ▼
                 ┌───────────────┐
                 │ Count Keywords│
                 │  + Frequency  │
                 └───────┬───────┘
                         ▼
                 ┌───────────────┐
                 │ USER_INSIGHTS │
                 │ likes_json:   │
                 │ [{k:"smile",  │
                 │   count:3}]   │
                 └───────────────┘
                         │
                         ▼
          ┌──────────────────────────┐
          │ Next Content Generation  │
          │ Uses these insights!     │
          └──────────────────────────┘


⚠️  ВАЖЛИВА ПРОБЛЕМА:
    25 ratings БЕЗ коментарів (70%) → ІГНОРУЮТЬСЯ!
    Тільки 11 ratings З коментарями аналізуються.


┌─────────────────────────────────────────────────────────────────────────────┐
│                         ТИПОВІ ЗАПИТИ (SQL QUERIES)                          │
└─────────────────────────────────────────────────────────────────────────────┘

1. Отримати топ-контент користувача:
   ───────────────────────────────────
   SELECT c.*, r.direction as user_rating
   FROM content c
   LEFT JOIN ratings r ON c.id = r.content_id AND r.user_id = $1
   WHERE c.user_id = $1
   ORDER BY c.like_rate DESC, c.created_at DESC
   LIMIT 10;

2. Отримати insights користувача:
   ──────────────────────────────
   SELECT likes_json, dislikes_json, preferences_json,
          total_swipes, total_likes, total_dislikes
   FROM user_insights
   WHERE user_id = $1;

3. Контент для свайпу (виключаючи оцінені):
   ──────────────────────────────────────────
   SELECT c.*
   FROM content c
   WHERE c.id NOT IN (
     SELECT content_id FROM ratings 
     WHERE user_id = $1 AND direction != 'down'
   )
   ORDER BY created_at DESC
   LIMIT 1;

4. Статистика контенту:
   ────────────────────
   SELECT 
     COUNT(*) as total,
     SUM(CASE WHEN direction='right' THEN 1 ELSE 0 END) as likes,
     SUM(CASE WHEN direction='left' THEN 1 ELSE 0 END) as dislikes,
     SUM(CASE WHEN direction='up' THEN 1 ELSE 0 END) as superlikes
   FROM ratings
   WHERE content_id = $1;


┌─────────────────────────────────────────────────────────────────────────────┐
│                     НОРМАЛІЗАЦІЯ ТА ДЕНОРМАЛІЗАЦІЯ                           │
└─────────────────────────────────────────────────────────────────────────────┘

НОРМАЛЬНА ФОРМА: 3NF (Third Normal Form)

ДЕНОРМАЛІЗОВАНІ ПОЛЯ (для швидкодії):
  • content.total_ratings     ← замість COUNT(*) від ratings
  • content.likes_count        ← замість COUNT(*) WHERE direction='right'
  • content.dislikes_count     ← замість COUNT(*) WHERE direction='left'
  • content.superlikes_count   ← замість COUNT(*) WHERE direction='up'
  • content.like_rate          ← розрахунок на основі вищих полів

ПЕРЕВАГИ:
  ✓ Швидкі запити (без JOIN)
  ✓ Можливість сортування за like_rate
  ✓ Менше навантаження на базу

НЕДОЛІКИ:
  ✗ Потрібен тригер для синхронізації
  ✗ Більше місця на диску


┌─────────────────────────────────────────────────────────────────────────────┐
│                      РОЗМІРИ ТАБЛИЦЬ (ESTIMATION)                            │
└─────────────────────────────────────────────────────────────────────────────┘

При 10,000 користувачах:

  ТАБЛИЦЯ           │  ЗАПИСІВ  │  РОЗМІР/ЗАПИС  │  ЗАГАЛОМ
  ──────────────────┼───────────┼────────────────┼──────────
  users             │   10,000  │    ~500 bytes  │    ~5 MB
  prompt_templates  │       50  │     ~2 KB      │  ~100 KB
  content           │  100,000  │     ~1 KB      │  ~100 MB
  ratings           │  500,000  │    ~300 bytes  │  ~150 MB
  user_insights     │   10,000  │     ~2 KB      │   ~20 MB
  ──────────────────┴───────────┴────────────────┴──────────
  ВСЬОГО:                                           ~275 MB


╔═══════════════════════════════════════════════════════════════════════════╗
║                              ПІДСУМОК                                      ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                            ║
║  ✅ Нормалізована структура (3NF)                                         ║
║  ✅ Всі зв'язки визначені та захищені (FK constraints)                   ║
║  ✅ Тригери автоматизують оновлення статистики                           ║
║  ✅ Індекси оптимізують всі частіпускані запити                          ║
║  ✅ JSONB для гнучких даних (insights, meta)                             ║
║  ✅ Денормалізація для швидкодії (content stats)                         ║
║  ⚠️  Insights базуються ТІЛЬКИ на коментарях (30% даних)                 ║
║                                                                            ║
╚═══════════════════════════════════════════════════════════════════════════╝

Версія: 1.0
Дата: 2025-11-21
СУБД: PostgreSQL 15
Статус: ✅ Production Ready
